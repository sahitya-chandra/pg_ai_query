name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

env:
  CMAKE_BUILD_TYPE: Release

jobs:
  validate-release:
    name: Validate Release
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
      previous_tag: ${{ steps.version.outputs.previous_tag }}
      repo_name: ${{ steps.version.outputs.repo_name }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Determine version
      id: version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
          IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
        else
          VERSION="${{ github.ref_name }}"
          # Check if it's a prerelease based on tag format
          if [[ "$VERSION" == *"-"* ]]; then
            IS_PRERELEASE="true"
          else
            IS_PRERELEASE="false"
          fi
        fi

        # Validate version format
        if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-.*)?$ ]]; then
          echo "ERROR: Invalid version format: $VERSION"
          echo "Expected format: v1.0.0 or v1.0.0-beta.1"
          exit 1
        fi

        # Get previous tag for changelog comparison
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        if [ -z "$PREVIOUS_TAG" ]; then
          # If no previous tag, use the first commit
          PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
        fi

        # Extract repo name from github.repository (owner/repo -> repo)
        REPO_NAME="${{ github.repository }}"
        REPO_NAME="${REPO_NAME#*/}"

        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
        echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
        echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT

        echo "Version: $VERSION"
        echo "Pre-release: $IS_PRERELEASE"
        echo "Previous tag: $PREVIOUS_TAG"
        echo "Repo name: $REPO_NAME"

    - name: Validate changelog
      run: |
        if [ -f CHANGELOG.md ]; then
          if grep -q "${{ steps.version.outputs.version }}" CHANGELOG.md; then
            echo "Changelog contains entry for ${{ steps.version.outputs.version }}"
          else
            echo "WARNING: No changelog entry found for ${{ steps.version.outputs.version }}"
            echo "Consider updating CHANGELOG.md"
          fi
        else
          echo "WARNING: No CHANGELOG.md found"
        fi

  build-release-artifacts:
    name: Build Release Artifacts
    needs: validate-release
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            pg_version: "14"
            platform_name: "linux-x86_64-pg14"
          - os: ubuntu-24.04
            pg_version: "15"
            platform_name: "linux-x86_64-pg15"
          - os: ubuntu-24.04
            pg_version: "16"
            platform_name: "linux-x86_64-pg16"
          - os: ubuntu-24.04
            pg_version: "17"
            platform_name: "linux-x86_64-pg17"
          - os: ubuntu-24.04
            pg_version: "18"
            platform_name: "linux-x86_64-pg18"
          - os: macos-latest
            pg_version: "14"
            platform_name: "macos-latest-pg14"
          - os: macos-latest
            pg_version: "15"
            platform_name: "macos-latest-pg15"
          - os: macos-latest
            pg_version: "16"
            platform_name: "macos-latest-pg16"
          - os: macos-latest
            pg_version: "17"
            platform_name: "macos-latest-pg17"
          - os: macos-latest
            pg_version: "18"
            platform_name: "macos-latest-pg18"

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Set artifact name
      id: artifact
      run: |
        ARTIFACT_NAME="pg_ai_query-${{ needs.validate-release.outputs.version }}-${{ matrix.platform_name }}"
        echo "name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
        echo "Artifact name: $ARTIFACT_NAME"

    - name: Install dependencies (Ubuntu)
      if: startsWith(matrix.os, 'ubuntu')
      run: |
        sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
        wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libssl-dev \
          pkg-config \
          gettext \
          libz-dev \
          postgresql-${{ matrix.pg_version }} \
          postgresql-server-dev-${{ matrix.pg_version }}

    - name: Install dependencies (macOS)
      if: startsWith(matrix.os, 'macos')
      run: |
        brew update
        brew install cmake openssl pkg-config postgresql@${{ matrix.pg_version }}

    - name: Configure CMake
      run: |
        if [[ "${{ matrix.os }}" == macos* ]]; then
          export PG_CONFIG=$(brew --prefix postgresql@${{ matrix.pg_version }})/bin/pg_config
          export OPENSSL_ROOT_DIR=$(brew --prefix openssl)
        else
          # Ubuntu: Use version-specific pg_config path
          export PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config
        fi

        cmake -B build \
              -DCMAKE_BUILD_TYPE=${{env.CMAKE_BUILD_TYPE}} \
              -DCMAKE_INSTALL_PREFIX=/tmp/pg_ai_query_install \
              -DPG_CONFIG="$PG_CONFIG" \
              -DPACKAGE_VERSION="${{ needs.validate-release.outputs.version }}"

    - name: Build extension
      run: |
        cmake --build build --config ${{env.CMAKE_BUILD_TYPE}} --parallel $(nproc 2>/dev/null || sysctl -n hw.ncpu)

    - name: Create installation package
      env:
        VERSION: ${{ needs.validate-release.outputs.version }}
        REPO_NAME: ${{ needs.validate-release.outputs.repo_name }}
      run: |
        # Install to temporary directory
        DESTDIR=/tmp/package cmake --install build

        # Create package structure
        mkdir -p package
        cd package

        # Copy extension files
        if [[ "${{ matrix.os }}" == macos* ]]; then
          PG_CONFIG=$(brew --prefix postgresql@${{ matrix.pg_version }})/bin/pg_config
        else
          # Ubuntu: Use version-specific pg_config path
          PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config
        fi

        SHAREDIR=$($PG_CONFIG --sharedir)
        PKGLIBDIR=$($PG_CONFIG --pkglibdir)

        mkdir -p "share/postgresql/extension"
        mkdir -p "lib/postgresql"

        # Copy files from installation
        cp -r /tmp/package${SHAREDIR}/extension/* share/postgresql/extension/ 2>/dev/null || true
        cp /tmp/package${PKGLIBDIR}/*.so lib/postgresql/ 2>/dev/null || true
        cp /tmp/package${PKGLIBDIR}/*.dylib lib/postgresql/ 2>/dev/null || true

        # Create install script
        cat > install.sh << 'EOF'
        #!/bin/bash
        set -e

        # Detect PostgreSQL installation
        if command -v pg_config >/dev/null 2>&1; then
            SHAREDIR=$(pg_config --sharedir)
            PKGLIBDIR=$(pg_config --pkglibdir)
        else
            echo "Error: pg_config not found. Please ensure PostgreSQL is installed."
            exit 1
        fi

        echo "Installing pg_ai_query extension..."
        echo "Share directory: $SHAREDIR"
        echo "Package lib directory: $PKGLIBDIR"

        # Copy files
        sudo cp -r share/postgresql/extension/* "$SHAREDIR/extension/"
        sudo cp lib/postgresql/* "$PKGLIBDIR/"

        echo "pg_ai_query extension installed successfully!"
        echo ""
        echo "To enable the extension in your database:"
        echo "  CREATE EXTENSION pg_ai_query;"
        echo ""
        echo "For configuration help, see:"
        echo "  https://github.com/${{ github.repository }}/blob/main/docs/src/configuration.md"
        EOF

        chmod +x install.sh

        # Create README
        cat > README.md << EOF
        # pg_ai_query ${VERSION}

        PostgreSQL AI Query Extension - Generate SQL queries from natural language using AI.

        ## Installation

        Run the install script:
        \`\`\`bash
        ./install.sh
        \`\`\`

        ## System Requirements

        - PostgreSQL ${{ matrix.pg_version }}+
        - ${{ matrix.os }} or compatible
        - OpenSSL development libraries

        ## Quick Start

        1. Install the extension:
           \`\`\`sql
           CREATE EXTENSION pg_ai_query;
           \`\`\`

        2. Configure API key in ~/.pg_ai.config:
           \`\`\`ini
           [openai]
           api_key = "your-api-key-here"
           \`\`\`

        3. Generate your first query:
           \`\`\`sql
           SELECT generate_query('show all users');
           \`\`\`

        ## Documentation

        Complete documentation: https://${{ github.repository_owner }}.github.io/${REPO_NAME}

        ## Support

        - Issues: https://github.com/${{ github.repository }}/issues
        - Discussions: https://github.com/${{ github.repository }}/discussions
        EOF

        # Create version info
        cat > VERSION << EOF
        Version: ${VERSION}
        Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        Platform: ${{ matrix.os }}
        PostgreSQL: ${{ matrix.pg_version }}
        Commit: ${{ github.sha }}
        EOF

    - name: Create tarball
      run: |
        ARTIFACT_NAME="${{ steps.artifact.outputs.name }}"
        cd package
        tar -czf "../${ARTIFACT_NAME}.tar.gz" .
        cd ..

        echo "Package created: ${ARTIFACT_NAME}.tar.gz"
        echo "Package size: $(du -h ${ARTIFACT_NAME}.tar.gz | cut -f1)"

    - name: Upload release artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.artifact.outputs.name }}
        path: ${{ steps.artifact.outputs.name }}.tar.gz
        retention-days: 30

  create-release:
    name: Create GitHub Release
    needs: [validate-release, build-release-artifacts]
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Generate release notes
      id: release_notes
      env:
        VERSION: ${{ needs.validate-release.outputs.version }}
        PREVIOUS_TAG: ${{ needs.validate-release.outputs.previous_tag }}
        REPO_NAME: ${{ needs.validate-release.outputs.repo_name }}
      run: |
        echo "Generating release notes..."

        # Start release notes
        cat > release_notes.md << EOF
        # pg_ai_query ${VERSION}

        **PostgreSQL AI Query Extension** - Generate SQL queries from natural language using AI.

        ## Installation

        Download the appropriate package for your platform below and follow the installation instructions.

        ## What's New

        EOF

        # Add changelog section if available
        if [ -f CHANGELOG.md ]; then
          echo "Adding changelog information..."
          # Extract changelog for this version
          sed -n "/## \[${VERSION}\]/,/## \[/p" CHANGELOG.md | head -n -1 >> release_notes.md || echo "No specific changelog entry found."
        fi

        # Add platform-specific installation notes
        cat >> release_notes.md << EOF

        ## Supported Platforms

        | Platform | PostgreSQL | File |
        |----------|------------|------|
        | Linux (x86_64) | 14 | \`pg_ai_query-${VERSION}-linux-x86_64-pg14.tar.gz\` |
        | Linux (x86_64) | 15 | \`pg_ai_query-${VERSION}-linux-x86_64-pg15.tar.gz\` |
        | Linux (x86_64) | 16 | \`pg_ai_query-${VERSION}-linux-x86_64-pg16.tar.gz\` |
        | Linux (x86_64) | 17 | \`pg_ai_query-${VERSION}-linux-x86_64-pg17.tar.gz\` |
        | Linux (x86_64) | 18 | \`pg_ai_query-${VERSION}-linux-x86_64-pg18.tar.gz\` |
        | macOS (latest) | 14 | \`pg_ai_query-${VERSION}-macos-latest-pg14.tar.gz\` |
        | macOS (latest) | 15 | \`pg_ai_query-${VERSION}-macos-latest-pg15.tar.gz\` |
        | macOS (latest) | 16 | \`pg_ai_query-${VERSION}-macos-latest-pg16.tar.gz\` |
        | macOS (latest) | 17 | \`pg_ai_query-${VERSION}-macos-latest-pg17.tar.gz\` |
        | macOS (latest) | 18 | \`pg_ai_query-${VERSION}-macos-latest-pg18.tar.gz\` |

        ## Documentation

        - **Complete Guide**: https://${{ github.repository_owner }}.github.io/${REPO_NAME}
        - **Quick Start**: [Installation Guide](https://${{ github.repository_owner }}.github.io/${REPO_NAME}/installation.html)
        - **Configuration**: [Configuration Guide](https://${{ github.repository_owner }}.github.io/${REPO_NAME}/configuration.html)

        ## Requirements

        - PostgreSQL 14+ with development headers
        - OpenAI or Anthropic API key
        - C++20 compatible compiler (for building from source)

        ## Quick Start

        1. Download and extract the appropriate package for your platform
        2. Run \`./install.sh\` to install the extension
        3. Connect to PostgreSQL and run: \`CREATE EXTENSION pg_ai_query;\`
        4. Configure your API key in \`~/.pg_ai.config\`
        5. Start generating queries: \`SELECT generate_query('show all users');\`

        ## Issues & Support

        - Report bugs: [GitHub Issues](https://github.com/${{ github.repository }}/issues)
        - Questions: [GitHub Discussions](https://github.com/${{ github.repository }}/discussions)
        - Documentation: [Official Docs](https://${{ github.repository_owner }}.github.io/${REPO_NAME})

        ---

        **Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREVIOUS_TAG}...${VERSION}
        EOF

        # Set output for next step
        echo "RELEASE_NOTES_FILE=release_notes.md" >> $GITHUB_OUTPUT

    - name: Create Release and Upload Assets
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        VERSION: ${{ needs.validate-release.outputs.version }}
        IS_PRERELEASE: ${{ needs.validate-release.outputs.is_prerelease }}
      run: |
        if [ "$IS_PRERELEASE" == "true" ]; then
          PRERELEASE_FLAG="--prerelease"
        else
          PRERELEASE_FLAG=""
        fi

        # Collect all tarball files
        ASSETS=""
        for artifact_dir in artifacts/*/; do
          for tarball in "$artifact_dir"*.tar.gz; do
            if [ -f "$tarball" ]; then
              ASSETS="$ASSETS $tarball"
            fi
          done
        done

        echo "Creating release with assets: $ASSETS"

        # Create release and upload all assets in one command
        gh release create "$VERSION" \
          --title "pg_ai_query $VERSION" \
          --notes-file release_notes.md \
          $PRERELEASE_FLAG \
          $ASSETS

  post-release:
    name: Post-Release Tasks
    needs: [validate-release, create-release]
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Update documentation version
      env:
        VERSION: ${{ needs.validate-release.outputs.version }}
        IS_PRERELEASE: ${{ needs.validate-release.outputs.is_prerelease }}
      run: |
        echo "Release ${VERSION} completed successfully!"
        echo "Release URL: https://github.com/${{ github.repository }}/releases/tag/${VERSION}"
        echo "Release Statistics:"
        echo "  - Version: ${VERSION}"
        echo "  - Pre-release: ${IS_PRERELEASE}"
        echo "  - Platforms: 10 supported platforms"
        echo "  - Documentation: Updated and deployed"
